<!DOCTYPE html>
<html>
<head>
    <title>Editor</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script src="./guide/lib/core/ht.js"></script>
    <script src="./guide/lib/core/ht-ui.js"></script>
    <script src="./guide/lib/plugin/ht-rulerframe.js"></script>
    <script src="./guide/lib/plugin/ht-cssanimation.js"></script>
    <script src="./guide/lib/plugin/ht-palette.js"></script>
    <script src="./guide/lib/plugin/ht-form.js"></script>
    <script src="createNodeInteractor.js"></script>
    <script type="text/javascript">
        function init() {
            ht.Default.setImage("cicle", {
                    "width": 100,
                    "height": 65,
                    "comps": [
                        {
                            "type": "circle",
                            "background": "rgb(255,255,255)",
                            "borderWidth": 2,
                            "borderColor": "rgb(0,0,0)",
                            "borderWidthAbsolute": true,
                            "rect": [
                                1.89338,
                                1.89338,
                                96.08909,
                                61.06154
                            ]
                        }
                    ]
                }
            );
            var palette = new ht.widget.Palette(),
                graphView = new ht.graph.GraphView(),
                splitView = new ht.widget.SplitView(palette, graphView, "h", 200),
                createNodeInteractor = new CreateNodeInteractor(graphView),
                view = splitView.getView(),
                style = view.style;

            initPaletteModel(palette.dm());

            palette.getView().style.position = "absolute";
            style.position = "absolute";
            style.top = "0";
            style.right = "0";
            style.bottom = "0";
            style.left = "0";

            palette.handleDragAndDrop = function(e, state) {
                if (state === 'end') {
                    var bound = graphView.getView().getBoundingClientRect(),
                        point = ht.Default.getClientPoint(e);

                    if (ht.Default.containsPoint({
                        x: bound.left,
                        y: bound.top,
                        width: bound.width,
                        height: bound.height
                    }, point)) {
                        var paletteNode = this.sm().ld(),
                            node = new ht.Node(),
                            lp = graphView.lp(e);
                        graphView.dm().add(node);
                        node.setPosition(lp.x, lp.y);
                        node.setImage(paletteNode.getImage());
                    }
                }
            };
            palette.sm().ms(function(e) {
                var selectedNode = palette.sm().ld();
                if (selectedNode) {
                    createNodeInteractor._image = selectedNode.getImage();
                }
            });

            graphView.setInteractors(new ht.List([
                new ht.graph.ScrollBarInteractor(graphView),
                new ht.graph.SelectInteractor(graphView),
                new ht.graph.MoveInteractor(graphView),
                new ht.graph.DefaultInteractor(graphView),
                new ht.graph.TouchInteractor(graphView),
                createNodeInteractor
            ]));
            graphView.setEditable(true);

            document.body.appendChild(view);
            window.addEventListener("resize", function(e) {
                splitView.iv();
            });
        }

        function initPaletteModel(model) {
            var group = new ht.Group(),
                draggableNode = new ht.Node();
            group.setExpanded(true);
            group.setName('拖拽图元');
            draggableNode.setImage("cicle");
            draggableNode.setName("cicle");
            draggableNode.s("draggable", true);
            group.addChild(draggableNode);
            model.add(group);
            model.add(draggableNode);
        }
    </script>
</head>
<body onload="init();">
</body>
</html>
